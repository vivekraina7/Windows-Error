<!-- templates/scan_results.html - Enhanced UI Design -->
{% extends "base.html" %}

{% block title %}Scan Results - Windows Dump Analyzer{% endblock %}

{% block content %}
<style>
    .results-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        color: white;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .results-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.1;
    }
    
    .results-header-content {
        position: relative;
        z-index: 2;
    }
    
    .result-card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        transition: all 0.3s ease;
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    
    .result-card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
        padding: 1.5rem;
        position: relative;
    }
    
    .result-card-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #dc3545, #fd7e14);
    }
    
    .confidence-badge {
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }
    
    .confidence-high {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
    }
    
    .confidence-medium {
        background: linear-gradient(135deg, #ffc107, #f39c12);
        color: white;
    }
    
    .confidence-low {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
    }
    
    .info-table {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .info-table td {
        padding: 0.75rem 1rem;
        border: none;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .info-table tr:last-child td {
        border-bottom: none;
    }
    
    .info-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .clickable-code {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-block;
        font-weight: 600;
    }
    
    .clickable-code:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }
    
    .section-header {
        padding: 1rem 0;
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .section-header::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 50px;
        height: 2px;
        background: linear-gradient(135deg, #667eea, #764ba2);
    }
    
    .solutions-section {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-top: 2rem;
        position: relative;
    }
    
    .solutions-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #28a745, #20c997);
        border-radius: 2px;
    }
    
    .no-solutions-section {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-top: 2rem;
        text-align: center;
        position: relative;
    }
    
    .no-solutions-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        border-radius: 2px;
    }
    
    .solution-step {
        background: white;
        border: none;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: all 0.2s ease;
        border-left: 4px solid #28a745;
    }
    
    .solution-step:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }
    
    .step-number {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .action-buttons {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .btn-modern {
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }
    
    .btn-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn-modern:hover::before {
        left: 100%;
    }
    
    .btn-success-modern {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .btn-success-modern:hover {
        background: linear-gradient(135deg, #34ce57, #28a745);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }
    
    .btn-warning-modern {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: white;
    }
    
    .btn-warning-modern:hover {
        background: linear-gradient(135deg, #ffcd39, #ffc107);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
    }
    
    .btn-primary-modern {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }
    
    .btn-primary-modern:hover {
        background: linear-gradient(135deg, #0086ff, #007bff);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }
    
    .btn-outline-modern {
        background: white;
        border: 2px solid #e9ecef;
        color: #495057;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-modern:hover {
        background: #f8f9fa;
        border-color: #dee2e6;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .stats-badge {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        display: inline-block;
    }
    
    .category-badge {
        background: linear-gradient(135deg, #6f42c1, #563d7c);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .no-results-section {
        text-align: center;
        padding: 4rem 2rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        margin: 2rem 0;
    }
    
    .floating-icon {
        animation: floating 3s ease-in-out infinite;
    }
    
    @keyframes floating {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .success-animation {
        animation: successPulse 0.6s ease-out;
    }
    
    @keyframes successPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .slide-in {
        animation: slideInUp 0.5s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

<!-- Results Header -->
<div class="results-header">
    <div class="results-header-content">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-6 fw-bold mb-2">
                    <i class="fas fa-chart-line me-3"></i>
                    Scan Results
                </h1>
                <p class="lead mb-0 opacity-75">Comprehensive analysis of your system's dump files</p>
            </div>
            <div class="text-end">
                <button type="button" class="btn btn-outline-light btn-modern me-2" onclick="exportResults()" title="Export results to JSON file">
                    <i class="fas fa-download me-2"></i>
                    Export Results
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-light btn-modern">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

{% if results %}
    <!-- Results Summary -->
    <div class="alert alert-success slide-in" style="border: none; border-radius: 15px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); box-shadow: 0 4px 20px rgba(40, 167, 69, 0.1);">
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle fa-2x text-success me-3"></i>
            <div>
                <h6 class="mb-1 fw-bold">Analysis Complete</h6>
                <p class="mb-0">Found and analyzed <span class="stats-badge">{{ results|length }}</span> dump file{{ 's' if results|length != 1 else '' }}</p>
            </div>
        </div>
    </div>

    {% for result in results %}
    <div class="result-card slide-in" style="animation-delay: {{ loop.index0 * 0.1 }}s;">
        <div class="result-card-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-2 fw-bold">
                        <i class="fas fa-file-code text-danger me-2"></i>
                        {{ result.file_info.filename }}
                    </h5>
                    <div class="d-flex align-items-center text-muted">
                        <i class="fas fa-hdd me-1"></i>
                        <small class="me-3">{{ result.file_info.size_mb }}MB</small>
                        <i class="fas fa-clock me-1"></i>
                        <small>Modified: {{ result.file_info.modified_time }}</small>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <span class="confidence-badge confidence-{{ result.get('confidence', 'low') }}">
                        <i class="fas fa-{{ 'check-circle' if result.get('confidence') == 'high' else 'exclamation-triangle' if result.get('confidence') == 'medium' else 'question-circle' }} me-1"></i>
                        {{ result.get('confidence', 'Unknown').title() }} Confidence
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card-body" style="padding: 2rem;">
            <!-- Error Information -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="section-header">
                        <h6 class="text-danger fw-bold mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error Details
                        </h6>
                    </div>
                    <table class="table info-table">
                        <tr>
                            <td><strong><i class="fas fa-bug me-1"></i>Error Code:</strong></td>
                            <td>
                                <code class="clickable-code" title="Click to copy">{{ result.error_code }}</code>
                            </td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-tag me-1"></i>Error Name:</strong></td>
                            <td>{{ result.get('error_name', 'Unknown') }}</td>
                        </tr>
                        {% if result.get('faulting_module') %}
                        <tr>
                            <td><strong><i class="fas fa-cube me-1"></i>Faulting Module:</strong></td>
                            <td><span class="badge bg-warning text-dark">{{ result.faulting_module }}</span></td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td><strong><i class="fas fa-folder-open me-1"></i>Category:</strong></td>
                            <td>
                                <span class="category-badge">{{ result.get('category', 'Unknown').title() }}</span>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="col-md-6">
                    <div class="section-header">
                        <h6 class="text-info fw-bold mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Analysis Details
                        </h6>
                    </div>
                    <table class="table info-table">
                        <tr>
                            <td><strong><i class="fas fa-cogs me-1"></i>Analysis Method:</strong></td>
                            <td><span class="badge bg-primary">{{ result.get('analyzer_method', 'Unknown').title() }}</span></td>
                        </tr>
                        <tr>
                            <td><strong><i class="fas fa-stopwatch me-1"></i>Analysis Time:</strong></td>
                            <td>{{ result.analysis_time }}</td>
                        </tr>
                        {% if result.get('process_name') %}
                        <tr>
                            <td><strong><i class="fas fa-microchip me-1"></i>Process:</strong></td>
                            <td><span class="badge bg-dark">{{ result.process_name }}</span></td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            {% if result.solutions and result.solutions.solutions %}
            <!-- Solutions Section -->
            <div class="solutions-section">
                <h6 class="text-success fw-bold mb-3">
                    <i class="fas fa-tools me-2"></i>
                    Recommended Solutions
                </h6>
                
                {% if result.solutions.description %}
                <div class="alert alert-info" style="border: none; border-radius: 10px; background: rgba(255,255,255,0.8);">
                    <i class="fas fa-info-circle me-2"></i>
                    {{ result.solutions.description }}
                </div>
                {% endif %}
                
                <div class="row">
                    <div class="col-12">
                        {% for solution in result.solutions.solutions %}
                        <div class="solution-step">
                            <div class="d-flex align-items-start">
                                <div class="step-number me-3">
                                    {{ solution.step }}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold mb-2">{{ solution.description }}</div>
                                    {% if solution.details %}
                                    <p class="text-muted mb-0">{{ solution.details }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons text-center">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success-modern btn-modern" onclick="markSolved('{{ result.error_code }}')">
                            <i class="fas fa-check me-2"></i>
                            Yes, this solved my problem
                        </button>
                        <button type="button" class="btn btn-warning-modern btn-modern" onclick="needMoreHelp('{{ result.error_code }}')">
                            <i class="fas fa-question-circle me-2"></i>
                            No, need More Help
                        </button>
                    </div>
                </div>
                
                {% if result.solutions.additional_info %}
                <div class="mt-3 p-3" style="background: rgba(255,255,255,0.6); border-radius: 10px;">
                    <small class="text-dark">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        <strong>Additional Info:</strong> {{ result.solutions.additional_info }}
                    </small>
                </div>
                {% endif %}
            </div>
            {% else %}
            <!-- No Solutions Found -->
            <div class="no-solutions-section">
                <div class="floating-icon mb-3">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                </div>
                <h6 class="fw-bold mb-3">No Solutions Found</h6>
                <p class="mb-4 text-muted">We couldn't find specific solutions for this error in our knowledge base, but our support team can help you resolve this issue.</p>
                <button type="button" class="btn btn-primary-modern btn-modern" onclick="contactSupport('{{ result.error_code }}')">
                    <i class="fas fa-headset me-2"></i>
                    Contact Support Team
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="no-results-section">
    <div class="floating-icon mb-4">
        <i class="fas fa-search fa-4x text-muted"></i>
    </div>
    <h3 class="text-muted fw-bold mb-3">No Results Found</h3>
    <p class="text-muted mb-4 lead">No dump files were found or analyzed in the recent scan. Your system appears to be running smoothly!</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary-modern btn-modern">
        <i class="fas fa-redo me-2"></i>
        Run Another Scan
    </a>
</div>
{% endif %}

<!-- Hidden data for JavaScript -->
<script id="results-data" type="application/json">
{% if results %}
{{ results | tojson | safe }}
{% else %}
[]
{% endif %}
</script>
{% endblock %}

{% block scripts %}
<script>
// Get results data from the hidden script tag
function getResultsData() {
    try {
        const scriptTag = document.getElementById('results-data');
        return JSON.parse(scriptTag.textContent);
    } catch (e) {
        console.error('Error parsing results data:', e);
        return [];
    }
}

// Track which error codes have been marked as solved
let solvedErrorCodes = new Set();

function markSolved(errorCode) {
    // Check if already marked as solved
    if (solvedErrorCodes.has(errorCode)) {
        showAlert('info', 'You have already marked this solution as helpful.');
        return;
    }
    
    // Find the button and update it
    const buttonGroup = event.target.closest('.btn-group');
    const solvedBtn = event.target;
    const helpBtn = buttonGroup.querySelector('.btn-warning-modern');
    
    // Update button state with animation
    solvedBtn.classList.add('success-animation');
    solvedBtn.innerHTML = '<i class="fas fa-check me-2"></i> Thank you for your feedback!';
    solvedBtn.className = 'btn btn-success-modern btn-modern';
    solvedBtn.disabled = true;
    
    // Hide the "Need More Help" button
    if (helpBtn) {
        helpBtn.style.display = 'none';
    }
    
    // Add to solved set
    solvedErrorCodes.add(errorCode);
    
    // Show success message
    showAlert('success', 'Thank you! We\'re glad the solution worked for you. Your feedback helps us improve our knowledge base.');
    
    // Send feedback to server
    fetch('/api/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            error_code: errorCode,
            feedback: 'solved',
            timestamp: new Date().toISOString(),
            user_agent: navigator.userAgent
        })
    }).then(response => {
        if (response.ok) {
            console.log('Feedback sent successfully');
            
            // Add a success icon next to the error code
            const errorCodeElement = document.querySelector(`code:contains("${errorCode}")`);
            if (errorCodeElement && !errorCodeElement.querySelector('.success-icon')) {
                const successIcon = document.createElement('i');
                successIcon.className = 'fas fa-check-circle text-success ms-2 success-icon';
                successIcon.title = 'Solution confirmed helpful';
                errorCodeElement.parentNode.appendChild(successIcon);
            }
        }
    }).catch(error => {
        console.log('Failed to send feedback:', error);
    });
    
    // Add celebration effect
    addCelebrationEffect(solvedBtn);
}

function needMoreHelp(errorCode) {
    // Check if already marked as solved
    if (solvedErrorCodes.has(errorCode)) {
        showAlert('info', 'You already marked this as solved. If you need additional help, please contact support.');
        return;
    }
    
    // Redirect to chatbot with context
    const chatbotUrl = `/chatbot?error_code=${encodeURIComponent(errorCode)}`;
    window.location.href = chatbotUrl;
}

function contactSupport(errorCode) {
    // Redirect to support form
    const supportUrl = `/support?error_code=${encodeURIComponent(errorCode)}`;
    window.location.href = supportUrl;
}

// Add celebration effect when solution is marked as solved
function addCelebrationEffect(button) {
    // Add confetti-like effect
    const rect = button.getBoundingClientRect();
    for (let i = 0; i < 8; i++) {
        createFloatingIcon(rect.left + rect.width/2, rect.top + rect.height/2);
    }
}

function createFloatingIcon(x, y) {
    const icons = ['âœ“', 'ðŸŽ‰', 'â­', 'âœ¨'];
    const icon = document.createElement('div');
    icon.innerHTML = icons[Math.floor(Math.random() * icons.length)];
    icon.style.position = 'fixed';
    icon.style.left = x + 'px';
    icon.style.top = y + 'px';
    icon.style.color = '#28a745';
    icon.style.fontSize = '20px';
    icon.style.fontWeight = 'bold';
    icon.style.pointerEvents = 'none';
    icon.style.zIndex = '9999';
    icon.style.transition = 'all 1s ease-out';
    
    document.body.appendChild(icon);
    
    // Animate
    setTimeout(() => {
        icon.style.transform = `translate(${(Math.random() - 0.5) * 100}px, -50px)`;
        icon.style.opacity = '0';
    }, 10);
    
    // Remove after animation
    setTimeout(() => {
        if (document.body.contains(icon)) {
            document.body.removeChild(icon);
        }
    }, 1000);
}

// Export results with enhanced feedback
function exportResults() {
    const resultsData = {
        scan_time: new Date().toISOString(),
        results: getResultsData(),
        export_version: "1.0",
        solved_items: Array.from(solvedErrorCodes)
    };
    
    const dataStr = JSON.stringify(resultsData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `dump_analysis_results_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('success', 'Results exported successfully! The file includes your feedback on solved issues.');
}

// Copy error code to clipboard with better feedback
function copyErrorCode(errorCode) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(errorCode).then(function() {
            showAlert('success', `Error code ${errorCode} copied to clipboard!`, true);
        }).catch(function(err) {
            console.error('Failed to copy: ', err);
            fallbackCopyText(errorCode);
        });
    } else {
        fallbackCopyText(errorCode);
    }
}

function fallbackCopyText(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showAlert('success', `Error code ${text} copied to clipboard!`, true);
        } else {
            showAlert('error', 'Failed to copy to clipboard');
        }
    } catch (err) {
        console.error('Fallback copy failed: ', err);
        showAlert('error', 'Copy to clipboard not supported');
    }
    
    document.body.removeChild(textArea);
}

// Enhanced alert system
function showAlert(type, message, autoClose = true) {
    const alertType = type === 'error' ? 'danger' : type;
    const icon = type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle';
    const gradientClass = type === 'success' ? 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)' : 
                         type === 'error' ? 'linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%)' : 
                         'linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%)';
    
    const alertId = 'alert-' + Date.now();
    const alertHtml = `
        <div id="${alertId}" class="alert alert-dismissible fade show shadow-sm" role="alert" 
             style="position: sticky; top: 20px; z-index: 1000; border: none; border-radius: 15px; background: ${gradientClass};">
            <div class="d-flex align-items-center">
                <i class="fas fa-${icon} me-3 fa-lg"></i>
                <div class="flex-grow-1">
                    <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong>
                    ${message}
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
    
    // Remove existing alerts of same type
    document.querySelectorAll(`.alert`).forEach(alert => {
        if (alert.id.startsWith('alert-')) alert.remove();
    });
    
    // Add new alert at the top
    const container = document.querySelector('main .container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss
    if (autoClose) {
        const dismissTime = type === 'success' ? 8000 : 5000;
        setTimeout(function() {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 500);
            }
        }, dismissTime);
    }
}

// Initialize page with enhanced functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for error codes to copy them
    document.querySelectorAll('.clickable-code').forEach(function(codeElement) {
        codeElement.addEventListener('click', function() {
            const errorCode = this.textContent;
            copyErrorCode(errorCode);
        });
        
        // Add hover effect
        codeElement.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
        });
        codeElement.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // Initialize Bootstrap tooltips
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+E to export results
        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            exportResults();
        }
        // Escape to close any open alerts
        if (e.key === 'Escape') {
            document.querySelectorAll('.alert .btn-close').forEach(btn => btn.click());
        }
    });
    
    const resultsCount = getResultsData().length;
    console.log(`Scan results page loaded with ${resultsCount} results`);
    
    // Add helpful tips
    if (resultsCount > 0) {
        setTimeout(() => {
            showAlert('info', 'Tip: Click on error codes to copy them to clipboard, or press Ctrl+E to export all results.', true);
        }, 2000);
    }
    
    // Animate elements on scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Observe all result cards
    document.querySelectorAll('.result-card').forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });
});

// Add CSS for enhanced animations and effects
const additionalStyles = document.createElement('style');
additionalStyles.textContent = `
    .btn:disabled {
        opacity: 0.8;
        transform: none !important;
    }
    
    .success-icon {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.5); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .clickable-code {
        position: relative;
    }
    
    .clickable-code::after {
        content: 'Click to copy';
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }
    
    .clickable-code:hover::after {
        opacity: 1;
    }
    
    .result-card {
        position: relative;
    }
    
    .result-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        border-radius: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .result-card:hover::before {
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .results-header {
            padding: 1.5rem;
            text-align: center;
        }
        
        .results-header .d-flex {
            flex-direction: column;
            gap: 1rem;
        }
        
        .result-card-header .row {
            text-align: center;
        }
        
        .btn-group {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .btn-group .btn {
            width: 100%;
        }
    }
`;
document.head.appendChild(additionalStyles);
</script>
{% endblock %}